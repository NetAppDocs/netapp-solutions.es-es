---
sidebar: sidebar 
permalink: containers/rh-os-n_use_case_openshift_virtualization_dataprotection_installation.html 
keywords: OpenShift, OCP, Astra Trident, NetApp ONTAP, Red Hat OpenShift, OpenShift Virtualization, CNV, Container Native Virtualization, Red Hat OpenShift Virtualization, OADP operator, Openshift Data Protection Application operator, velero 
summary: Protección de datos de virtualización de Red Hat OpenShift con NetApp ONTAP 
---
= Instalación del operador de la API de OpenShift para la protección de datos (OADP)
:hardbreaks:
:allow-uri-read: 
:nofooter: 
:icons: font
:linkattrs: 
:imagesdir: ./../media/




== Requisitos previos

* Un clúster Red Hat OpenShift (posterior a la versión 4,12) instalado en una infraestructura básica con nodos de trabajo RHCOS
* Un clúster de NetApp ONTAP integrado con el clúster mediante Astra Trident
* Un back-end de Trident configurado con una SVM en un clúster de ONTAP
* Un StorageClass configurado en el clúster OpenShift con Astra Trident como aprovisionador
* La clase Snapshot de Trident creada en el clúster
* Acceso de administrador de clúster al clúster de Red Hat OpenShift
* Acceso de administrador al clúster de ONTAP de NetApp
* Operador de virtualización de OpenShift instalado y configurado
* Equipos virtuales implementados en un espacio de nombres en la virtualización OpenShift
* Una estación de trabajo de administración con herramientas trimentctl y oc instaladas y agregadas a $PATH



NOTE: Si desea realizar una copia de seguridad de una máquina virtual cuando se encuentra en estado de ejecución, debe instalar el agente invitado QEMU en esa máquina virtual. Si instala la máquina virtual con una plantilla existente, el agente QEMU se instala automáticamente. QEMU permite al agente invitado detener los datos en tránsito en el SO invitado durante el proceso de instantánea y evitar posibles daños en los datos. Si no tiene QEMU instalado, puede detener la máquina virtual antes de realizar una copia de seguridad.



== Pasos para instalar OADP Operator

. Vaya al Centro del operador del clúster y seleccione Operador OADP de Red Hat. En la página Install, utilice todas las selecciones predeterminadas y haga clic en install. En la página siguiente, vuelva a utilizar todos los valores predeterminados y haga clic en Instalar. El operador OADP se instalará en el espacio de nombres denominado openshift-adp.


image::redhat_openshift_OADP_install_image1.jpg[API de OpenShift para protección de datos en Operator Hub]

image::redhat_openshift_OADP_install_image2.jpg[Instalación de la API de OpenShift para el operador de protección de datos]

image::redhat_openshift_OADP_install_image3.jpg[API de OpenShift para el operador de protección de datos instalado]



=== Requisitos previos para la configuración de Velero con ONTAP S3 DETALLES:

Una vez que la instalación del operador tenga éxito, configure la instancia de Velero.
Velero se puede configurar para utilizar el almacenamiento de objetos compatible con S3. Configure ONTAP S3 utilizando los procedimientos que se muestran en la link:https://docs.netapp.com/us-en/ontap/object-storage-management/index.html["Sección Gestión de almacenamiento de objetos de la documentación de ONTAP"]. Necesitará la siguiente información de su configuración de ONTAP S3 para integrarla con Velero.

* Una interfaz lógica (LIF) IP que se puede utilizar para acceder a S3
* Credenciales de usuario para acceder a S3 que incluye la clave de acceso y la clave de acceso secreta
* Un nombre de bloque en S3 para backups con permisos de acceso para el usuario
* Para obtener un acceso seguro al almacenamiento de objetos, el certificado TLS se debe instalar en el servidor de almacenamiento de objetos.




=== Pasos para configurar Velero

* En primer lugar, cree un secreto para las credenciales de usuario de ONTAP S3. Se utilizará para configurar Velero más adelante. Puede crear un secreto desde la CLI o desde la consola web.
Para crear un secreto desde la consola web, seleccione Secretos y, a continuación, haga clic en Clave/Valor Secreto.
Proporcione los valores para el nombre de la credencial, la clave y el valor que se muestra. Asegúrese de utilizar el ID de clave de acceso y la clave de acceso secreta de su usuario de S3.


image::redhat_openshift_OADP_install_image4.jpg[Secreto para las credenciales de ONTAP S3]

image::redhat_openshift_OADP_install_image5.jpg[Crear secreto para las credenciales de ONTAP S3]


NOTE: Para crear el secreto predeterminado con nombres credenciales del cloud desde la CLI, puede usar el siguiente comando. Si las ubicaciones de copia de seguridad y instantáneas utilizan las mismas credenciales, solo tiene que crear el secreto predeterminado como se muestra anteriormente. Para otros escenarios, consulte la documentación de OADP.

image::redhat_openshift_OADP_install_image6.jpg[Cree Secret para las credenciales de ONTAP S3 mediante la interfaz de línea de comandos]

* A continuación, para Configurar Velero, seleccione Operadores instalados en el elemento de menú en Operadores, haga clic en Operador OADP y, a continuación, seleccione la pestaña DataProtectionApplication.


image::redhat_openshift_OADP_install_image7.jpg[Aplicación de protección de datos]

Haga clic en Create DataProtectionApplication. En la vista Formulario, proporcione un nombre para la aplicación DataProtection o utilice el nombre predeterminado.

image::redhat_openshift_OADP_install_image8.jpg[Crear DataProtectionApplication]

Ahora vaya a la vista YAML y reemplace la información predeterminada o agregue la información como se muestra en el archivo yaml a continuación.

....
spec:
  backupLocations:
    - velero:
        config:
          insecureSkipTLSVerify: 'true' //use this for https communication with ONTAP S3
          profile: default
          region: us-east
          s3ForcePathStyle: 'True' //This allows use of IP in s3URL
          s3Url: 'https://10.xx.xx.xx' //Ensure TLS certificate for S3 is configured
        credential:
          key: cloud
          name: cloud-credentials //previously created secret named cloud-credentials
        default: true
        objectStorage:
          bucket: velero //Your bucket name previously created in S3 for backups
          prefix: demobackup //The folder that will be created in the bucket
        provider: aws
  configuration:
    nodeAgent:
      enable: true
      uploaderType: kopia
                    //default Data Mover uses Kopia to move snapshots to Object  Storage
    velero:
      defaultPlugins:
        - csi //Add this plugin
        - openshift
        - aws
        - kubevirt //Add this plugin
  snapshotLocations:
    - velero:
        config:
          profile: default
          region: us-east
        provider: aws
....
El YAML anterior tiene las siguientes secciones en la especificación que deben configurarse adecuadamente de manera similar al ejemplo:

**BackupLocations**
ONTAP S3 (con sus credenciales y otra información como se muestra en el yaml) está configurado como la ubicación de copia de seguridad predeterminada para velero.

**SnapshotLocations**
ONTAP S3 está configurado como la ubicación predeterminada para las instantáneas de PVC para Velero.

**Habilitar CSI**
Agregue csi a los defaultPlugins para Velero para realizar copias de seguridad de volúmenes persistentes con snapshots CSI.
Los plugins de Velero CSI, para respaldar los PVCs respaldados por CSI, elegirán el VolumeSnapshotClass en el clúster que tiene la etiqueta **velero.io/csi-volumesnapshot-class** establecida en él. Para esto

* Debe tener creado el trident VolumeSnapshotClass.
* Edite la etiqueta de la clase trident-snapshotclass y establézcala en
**velero.io/csi-volumesnapshot-class=true** como se muestra a continuación.


image::redhat_openshift_OADP_install_image9.jpg[Etiqueta de la clase de Snapshot de Trident]

Asegúrese de que las snapshots puedan persistir incluso si se han eliminado los objetos de VolumeSnapshot. Esto se puede hacer configurando la política de eliminación en Retener. De lo contrario, al eliminar un espacio de nombres se perderán por completo todas las RVP de las que se haya realizado un backup.

....
apiVersion: snapshot.storage.k8s.io/v1
kind: VolumeSnapshotClass
metadata:
  name: trident-snapshotclass
driver: csi.trident.netapp.io
deletionPolicy: Retain
....
image::redhat_openshift_OADP_install_image10.jpg[La política de eliminación de VolumeSnapshotClass debe establecerse en Retain]

Asegúrese de que se ha creado la aplicación DataProtectionApplication y que se encuentra en Condición:Reconciliada.

image::redhat_openshift_OADP_install_image11.jpg[Se ha creado el objeto DataProtectionApplication]

El operador OADP creará una BackupStorageLocation correspondiente. Se utilizará al crear una copia de seguridad.

image::redhat_openshift_OADP_install_image12.jpg[Se crea BackupStorageLocation]
